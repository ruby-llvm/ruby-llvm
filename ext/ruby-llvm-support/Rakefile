require 'rubygems'
require 'rake/clean'
require 'ffi'

require File.expand_path('../../lib/llvm/version', File.dirname(__FILE__))
include LLVM

def check_llvm_config(name)
  actual_version = `#{name} --version`
  actual_version.strip == LLVM_VERSION
rescue Errno::ENOENT
  false
end

def invoke_llvm_config(options)
  variants = %W(llvm-config-#{LLVM_VERSION} llvm-config)

  variants.each do |name|
    if check_llvm_config(name)
      return `#{name} #{options}`.gsub("\n", " ")
    end
  end

  raise RuntimeError, "No valid llvm-config found. Tried: #{variants}"
end

LLVM_CONFIG = invoke_llvm_config('--cxxflags --ldflags')

CXX    = "g++"
SRC    = "support.cpp"

SUPPORT_LIB = FFI.map_library_name("RubyLLVMSupport-#{LLVM_VERSION}")
CONFIG_MOD  = File.expand_path('../../lib/llvm/config.rb', File.dirname(__FILE__))

CLEAN.include(SUPPORT_LIB, CONFIG_MOD)

desc "Build the shared library and config module"
task :default => [SUPPORT_LIB, CONFIG_MOD]

file SUPPORT_LIB => [SRC] do
  sh "#{CXX} -shared -lLLVM-#{LLVM_VERSION} #{SRC} #{LLVM_CONFIG} -o #{SUPPORT_LIB}"
end

LLVM_CONFIG_OPTS = [
  ['COMPONENTS',    :array,  '--components'],
  ['TARGETS_BUILT', :array,  '--targets-built'],
  ['HOST_TARGET',   :string, '--host-target'],
  ['BUILD_MODE',    :string, '--build-mode'],
]

file CONFIG_MOD do
  open(CONFIG_MOD, 'w') do |f|
    f.puts '# Generated by ruby-llvm. Please do not change this file by hand.'
    f.puts 'module LLVM'
    f.puts '  module CONFIG'

    LLVM_CONFIG_OPTS.each do |(const, fmt, flag)|
      case fmt
      when :string
        f.puts '    ' << const << ' = ' << invoke_llvm_config(flag).strip.inspect
      when :array
        f.puts '    ' << const << ' = ' << invoke_llvm_config(flag).strip.split.inspect
      end
    end

    f.puts '  end'
    f.puts 'end'
  end
end
